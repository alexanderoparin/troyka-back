# Troyka Back

Backend-приложение на Java с использованием Spring Boot.

## Описание

Это backend-приложение предоставляет REST API для работы с различными функциями, включая:
- Аутентификацию и авторизацию пользователей
- Генерацию изображений с помощью FAL AI
- Редактирование изображений с помощью FAL AI
- Загрузку и хранение файлов
- Систему поинтов пользователей для оплаты генерации изображений

## Основные эндпоинты

### Аутентификация
- `POST /auth/register` - Регистрация нового пользователя
- `POST /auth/login` - Вход в систему

### Генерация изображений
- `POST /fal/image/run/create` - Создание нового изображения по описанию (требуется 3 поинта за изображение)

### Работа с файлами
- `POST /files/upload` - Загрузка файлов (требуется аутентификация)
- `GET /files/{filename}` - Получение загруженных файлов (публичный доступ)

### Поинты пользователя
- `GET /fal/user/points` - Получение текущего баланса пользователя

## Настройка окружения

### Переменные окружения

Для работы приложения необходимо установить следующие переменные окружения:

- `DB_HOST` - Хост базы данных PostgreSQL (по умолчанию: localhost)
- `DB_PORT` - Порт базы данных PostgreSQL (по умолчанию: 5432)
- `DB_NAME` - Имя базы данных (по умолчанию: postgres)
- `DB_SCHEMA` - Схема базы данных (по умолчанию: troyka)
- `DB_USERNAME` - Имя пользователя базы данных
- `DB_PASSWORD` - Пароль пользователя базы данных
- `JWT_SECRET` - Секрет для подписи JWT токенов
- `JWT_EXPIRATION` - Время жизни JWT токена в миллисекундах (по умолчанию: 86400000)
- `fal_ai_api_key` - API ключ для доступа к FAL AI
- `UPLOAD_DIR` - Директория для хранения загруженных файлов (по умолчанию: /var/www/uploads/)

### Подготовка директории для загрузки файлов

Перед запуском приложения необходимо создать директорию для хранения загруженных файлов:

```bash
# Запустите скрипт из корня проекта
chmod +x scripts/create-upload-dir.sh
sudo ./scripts/create-upload-dir.sh
```

Или вручную создайте директорию:
```bash
sudo mkdir -p /var/www/uploads
sudo chmod 755 /var/www/uploads
```

## Структура базы данных

### Таблица пользователей (user)
Стандартные поля пользователя:
- `id` - уникальный идентификатор
- `username` - имя пользователя
- `email` - email пользователя
- `password` - хэш пароля
- `first_name` - имя
- `last_name` - фамилия
- `role` - роль пользователя
- `created_at` - дата создания
- `updated_at` - дата обновления

### Таблица поинтов пользователей (user_points)
Отдельная таблица для хранения поинтов пользователей:
- `user_id` - ссылка на пользователя (первичный ключ)
- `points` - количество поинтов пользователя
- `created_at` - дата создания записи
- `updated_at` - дата обновления записи

## Запуск приложения

### Локальный запуск

1. Установите все необходимые переменные окружения
2. Запустите приложение:
   ```bash
   mvn spring-boot:run
   ```

### Сборка и запуск JAR-файла

1. Соберите проект:
   ```bash
   mvn clean package
   ```

2. Запустите собранный JAR-файл:
   ```bash
   java -jar target/troyka-back-*.jar
   ```

## Документация API

После запуска приложения документация API доступна по адресу:
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- OpenAPI specification: `http://localhost:8080/v3/api-docs`